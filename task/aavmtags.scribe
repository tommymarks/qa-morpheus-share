resource "task" "aavmtags" {
  code = "aavmtags"
  name = "vcenter tags"
  uuid = "435b2733-bd5f-4e7d-ab2d-c18f463c26dd"
  allowCustomConfig = false
  dateCreated = "2019-10-15T00:43:34.000Z"
  executeTarget = "local"
  lastUpdated = "2020-03-25T20:24:41.000Z"
  options = [
    {
      uuid = "48cb4c41-fd80-43c2-8545-ff0be86df3d3"
      optionType = { code = "username" }
    },
    {
      uuid = "591c0201-802f-4bf5-b041-7a50571d2d89"
      optionType = { code = "host" }
    },
    {
      uuid = "71068a1c-39cb-4fa3-ae2f-15d06ee0052d"
      optionType = { code = "localScriptGitId" }
    },
    {
      uuid = "7ba362a1-d9eb-4181-9a90-42265bcec9f9"
      optionType = { code = "port" }
    },
    {
      uuid = "7d8d4f54-9be4-464f-849e-0e3ce66bd71a"
      optionType = { code = "password" }
    },
    {
      uuid = "7f72be53-1354-4ef5-a22a-c925e035e0ed"
      optionType = { code = "localScriptGitRef" }
    },
    {
      uuid = "e778731d-ae21-4dc7-8fd7-36970e90c0f8"
      content = { uuid = "18c3af0b-1272-4ecd-ba8c-b945dd3af73d" }
      optionType = { code = "groovyScript" }
      value = <<EOF
import com.morpheus.util.ApiUtility
/**
* This script connects to vmware and applies a tag from a custom option by name to a virtual machine.
* This is a morpheus automation script that expects the vmware credentials to live in cypher under the following keys "secret/vcenter_url", "secret/vcenter_user" and "secret/vcenter_pass"
* TODO: This should probably be adjusted to handle categories as tags are not unique globally and can vary across category
* @author David Estes
*/
 
def findTagByName(apiUrl,sessionId,categoryId,tagName) {
                def apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/tag",null,null,[headers: ["vmware-api-session-id": sessionId]],'GET')
                println "finding tag by name: ${tagName} - ${categoryId}"
                if(apiResults.success) {
                println "Tag Ids: ${apiResults.success} - ${apiResults.data?.value}"
                                String tagId = apiResults.data?.value?.find { tagId ->
                                                apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/tag/id:${tagId}",null,null,[headers: ["vmware-api-session-id": sessionId]],'GET')
                                                println "tag result: ${tagId} - ${apiResults}"
                                                if(apiResults.success) {
                                                println "Name match: ${tagName} - ${tagName.class.name} - ${apiResults.data.value.name.class.name} ${apiResults.data.value.name.toString() == tagName.toString()} category match: ${apiResults.data.value.category_id == categoryId}"
                                                                if(apiResults.data.value.name.toString() == tagName.toString() && apiResults.data.value.category_id == categoryId) {
                                                                println "match found!"
                                                                                return true
                                                                } else {
                                                                                return false
                                                                }
                                                } else {
                                                                throw new Exception("Error Getting Tag Details: ${apiResults.content}")
                                                }
                                }
                                return tagId
                } else {
                                return null
                }
}
 
def findCategoryByName(apiUrl,sessionId,categoryName) {
                def apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/category",null,null,[headers: ["vmware-api-session-id": sessionId]],'GET')
                if(apiResults.success) {
                                String categoryId = apiResults.data?.value?.find { tagId ->
                                                apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/category/id:${tagId}",null,null,[headers: ["vmware-api-session-id": sessionId]],'GET')
                                                if(apiResults.success) {
                                                                if(apiResults.data.value.name == categoryName) {
                                                                                return true
                                                                } else {
                                                                                return false
                                                                }
                                                } else {
                                                                throw new Exception("Error Getting Tag Details: ${apiResults.content}")
                                                }
                                }
                                return categoryId
                } else {
                                return null
                }
}
 
def createCategory(apiUrl,sessionId,categoryName) {
                def body = [create_spec: [
                                associable_types: ['VirtualMachine'],
                                cardinality: 'SINGLE',
                                name:categoryName,
                                description: categoryName
                ]
                ]
                def apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/category",null,null,[headers: ["vmware-api-session-id": sessionId], body: body],'POST')
                return apiResults.success ? apiResults.data.value : null
}
 
def createTag(apiUrl,sessionId,categoryId,tagName) {
                def body = [create_spec: [
                                category_id: categoryId,
                                name:tagName,
                                description: tagName
                ]
                ]
                def apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/tag",null,null,[headers: ["vmware-api-session-id": sessionId], body: body],'POST')
                return apiResults.success ? apiResults.data.value : null
}
 
def applyTags(apiUrl,username,password,vmId,tagsMap) {
                String sessionId
                Map apiResults //used for tracking api results as api commands are called
                Map body //body json map if needed
                Map query //query params
                try {
                                apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/session",username,password,[:],'POST')
                                if(apiResults.success) {
                                                sessionId = apiResults.data.value
                                }
        println "Acquired Session Id: ${sessionId}"
                                tagsMap.each { tagKey,tagValue ->
               if(!tagValue || tagValue == 'null') {
              //no tag value, ignore this one
              return
            }
                        println "Applying Tag: ${tagKey} -- ${tagValue}"
                                                def categoryId = findCategoryByName(apiUrl,sessionId,tagKey)
                                                if(!categoryId) {
                                                                categoryId = createCategory(apiUrl,sessionId,tagKey)
                                                }
                                                def tagId = findTagByName(apiUrl,sessionId,categoryId,tagValue)
                                                if(!tagId) {
                                                                tagId = createTag(apiUrl,sessionId,categoryId,tagValue)
                                                }
                                                if(tagId && categoryId) {
                println "tagId: ${tagId} -- ${categoryId}"
                                                                query = ['~action':'attach']
                                                                body = [object_id: [type: 'VirtualMachine', id: vmId]]
                                                                apiResults = ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/tagging/tag-association/id:${tagId}",null,null,[headers: ["vmware-api-session-id": sessionId], body: body, query:query],'POST')
                                                                if(!apiResults.success) {
                                                                                throw new Exception("Error Associating Tag to VM: ${apiResults.content}")
                                                                }
                                                } else {

              println "apiResults: ${apiResults} - ${body} - ${tagId} - ${categoryId}"
            }
                                }
                } finally {
                                //Logout of the session when we are done
                                if(sessionId) {
                                                ApiUtility.callJsonApi(apiUrl,"/rest/com/vmware/cis/session",null,null,[headers: ["vmware-api-session-id": sessionId]],'DELETE')
                                }
                }
}
//Setup Givens
String apiUrl = cypher.read("secret/vcenter_api_url")
String vmId = server.externalId
String username = cypher.read("secret/vcenter_api_user")
String password = cypher.read("secret/vcenter_api_pass")
Map tagsMap = [
"aa-costcenter" : customOptions.Application_CostCenter,
"aa-archer-id" : customOptions.Application_Archer_id,
"aa-sdlc-environment" : customOptions.Application_sdlc_environment,
"aa-criticality" : customOptions.Application_Criticality,
"aa-application" : customOptions.Application_Name,
"aa-vm-type" : "VM"
]
println "Connecting to VCENTER: ${apiUrl} as ${username}"
println "tags${tagsMap}"
applyTags(apiUrl,username,password,vmId,tagsMap)
EOF
    }
  ]
  retryCount = 5
  retryDelaySeconds = 10
  retryable = false
  taskType = { code = "groovyTask" }
  visibility = "private"
}